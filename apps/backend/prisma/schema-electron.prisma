// Schema Prisma para BarManager Pro
// Baseado 100% na estrutura do SQLite do Electron Desktop
// Gerado em: 30/11/2025

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// FILIAIS
// ============================================

model Branch {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  address   String?
  phone     String?
  isMain    Boolean  @default(false) @map("is_main")
  isActive  Boolean  @default(true) @map("is_active")
  synced    Boolean  @default(false)
  lastSync  DateTime? @map("last_sync")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  users         User[]
  sales         Sale[]
  cashBoxes     CashBox[]
  debts         Debt[]
  purchases     Purchase[]
  tables        Table[]
  tableSessions TableSession[]
  inventory     Inventory[]
  stockMovements StockMovement[]

  @@map("branches")
}

// ============================================
// USUÁRIOS
// ============================================

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  fullName     String    @map("full_name")
  passwordHash String    @map("password_hash")
  role         String    @default("cashier")
  branchId     String?   @map("branch_id")
  branch       Branch?   @relation(fields: [branchId], references: [id])
  phone        String?
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  synced       Boolean   @default(false)
  lastSync     DateTime? @map("last_sync")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// ============================================
// CATEGORIAS
// ============================================

model Category {
  id          String     @id @default(uuid())
  name        String
  description String?
  parentId    String?    @map("parent_id")
  parent      Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children    Category[] @relation("SubCategories")
  sortOrder   Int        @default(0) @map("sort_order")
  isActive    Boolean    @default(true) @map("is_active")
  synced      Boolean    @default(false)
  lastSync    DateTime?  @map("last_sync")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  products Product[]

  @@map("categories")
}

// ============================================
// FORNECEDORES
// ============================================

model Supplier {
  id            String    @id @default(uuid())
  code          String    @unique
  name          String
  contactPerson String?   @map("contact_person")
  phone         String?
  email         String?
  address       String?
  taxId         String?   @map("tax_id")
  paymentTerms  String?   @map("payment_terms")
  notes         String?
  isActive      Boolean   @default(true) @map("is_active")
  synced        Boolean   @default(false)
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  products  Product[]
  purchases Purchase[]

  @@map("suppliers")
}

// ============================================
// PRODUTOS
// ============================================

model Product {
  id               String    @id @default(uuid())
  sku              String    @unique
  barcode          String?   @unique
  name             String
  nameKriol        String?   @map("name_kriol")
  nameFr           String?   @map("name_fr")
  categoryId       String?   @map("category_id")
  category         Category? @relation(fields: [categoryId], references: [id])
  supplierId       String?   @map("supplier_id")
  supplier         Supplier? @relation(fields: [supplierId], references: [id])
  priceUnit        Int       @map("price_unit")
  priceBox         Int?      @map("price_box")
  costUnit         Int       @map("cost_unit")
  costBox          Int?      @map("cost_box")
  unitsPerBox      Int       @default(1) @map("units_per_box")
  boxEnabled       Boolean   @default(false) @map("box_enabled")
  trackInventory   Boolean   @default(true) @map("track_inventory")
  lowStockAlert    Int       @default(10) @map("low_stock_alert")
  isMuntuEligible  Boolean   @default(false) @map("is_muntu_eligible")
  muntuQuantity    Int?      @map("muntu_quantity")
  muntuPrice       Int?      @map("muntu_price")
  minMarginPercent Float     @default(0) @map("min_margin_percent")
  taxRate          Float     @default(0) @map("tax_rate")
  isActive         Boolean   @default(true) @map("is_active")
  doseEnabled      Boolean   @default(false) @map("dose_enabled")
  dosesPerBottle   Int?      @map("doses_per_bottle")
  synced           Boolean   @default(false)
  lastSync         DateTime? @map("last_sync")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  saleItems      SaleItem[]
  purchaseItems  PurchaseItem[]
  inventory      Inventory[]
  inventoryItems InventoryItem[]
  stockMovements StockMovement[]
  tableOrders    TableOrder[]

  @@map("products")
}

// ============================================
// CLIENTES
// ============================================

model Customer {
  id            String    @id @default(uuid())
  code          String    @unique
  fullName      String    @map("full_name")
  phone         String?
  email         String?
  creditLimit   Int       @default(0) @map("credit_limit")
  currentDebt   Int       @default(0) @map("current_debt")
  isBlocked     Boolean   @default(false) @map("is_blocked")
  loyaltyPoints Int       @default(0) @map("loyalty_points")
  synced        Boolean   @default(false)
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  sales          Sale[]
  debts          Debt[]
  tableCustomers TableCustomer[]

  @@map("customers")
}

// ============================================
// MESAS
// ============================================

model Table {
  id        String   @id @default(uuid())
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])
  number    String
  seats     Int      @default(4)
  area      String?
  qrCode    String?  @map("qr_code")
  isActive  Boolean  @default(true) @map("is_active")
  synced    Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sessions TableSession[]

  @@unique([branchId, number])
  @@map("tables")
}

// ============================================
// SESSÕES DE MESA
// ============================================

model TableSession {
  id            String    @id @default(uuid())
  tableId       String    @map("table_id")
  table         Table     @relation(fields: [tableId], references: [id])
  branchId      String    @map("branch_id")
  branch        Branch    @relation(fields: [branchId], references: [id])
  sessionNumber String    @map("session_number")
  status        String    @default("open")
  openedBy      String    @map("opened_by")
  closedBy      String?   @map("closed_by")
  openedAt      DateTime  @default(now()) @map("opened_at")
  closedAt      DateTime? @map("closed_at")
  totalAmount   Int       @default(0) @map("total_amount")
  paidAmount    Int       @default(0) @map("paid_amount")
  notes         String?
  synced        Boolean   @default(false)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  customers TableCustomer[]
  orders    TableOrder[]
  payments  TablePayment[]
  actions   TableAction[]

  @@map("table_sessions")
}

// ============================================
// CLIENTES DE MESA (conta individual)
// ============================================

model TableCustomer {
  id            String        @id @default(uuid())
  sessionId     String        @map("session_id")
  session       TableSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  customerName  String        @map("customer_name")
  customerId    String?       @map("customer_id")
  customer      Customer?     @relation(fields: [customerId], references: [id])
  orderSequence Int           @default(1) @map("order_sequence")
  subtotal      Int           @default(0)
  discount      Int           @default(0)
  total         Int           @default(0)
  paidAmount    Int           @default(0) @map("paid_amount")
  paymentStatus String        @default("pending") @map("payment_status")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  orders   TableOrder[]
  payments TablePayment[]

  @@map("table_customers")
}

// ============================================
// PEDIDOS DE MESA
// ============================================

model TableOrder {
  id              String         @id @default(uuid())
  sessionId       String         @map("session_id")
  session         TableSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tableCustomerId String         @map("table_customer_id")
  tableCustomer   TableCustomer  @relation(fields: [tableCustomerId], references: [id], onDelete: Cascade)
  productId       String         @map("product_id")
  product         Product        @relation(fields: [productId], references: [id])
  qtyUnits        Int            @map("qty_units")
  isMuntu         Boolean        @default(false) @map("is_muntu")
  unitPrice       Int            @map("unit_price")
  unitCost        Int            @map("unit_cost")
  subtotal        Int
  discount        Int            @default(0)
  total           Int
  status          String         @default("pending")
  notes           String?
  orderedBy       String         @map("ordered_by")
  orderedAt       DateTime       @default(now()) @map("ordered_at")
  cancelledAt     DateTime?      @map("cancelled_at")
  cancelledBy     String?        @map("cancelled_by")
  synced          Boolean        @default(false)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("table_orders")
}

// ============================================
// PAGAMENTOS DE MESA
// ============================================

model TablePayment {
  id              String         @id @default(uuid())
  sessionId       String         @map("session_id")
  session         TableSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tableCustomerId String?        @map("table_customer_id")
  tableCustomer   TableCustomer? @relation(fields: [tableCustomerId], references: [id])
  paymentId       String?        @map("payment_id")
  payment         Payment?       @relation(fields: [paymentId], references: [id])
  method          String
  amount          Int
  referenceNumber String?        @map("reference_number")
  status          String         @default("completed")
  processedBy     String         @map("processed_by")
  processedAt     DateTime?      @map("processed_at")
  notes           String?
  synced          Boolean        @default(false)
  createdAt       DateTime       @default(now()) @map("created_at")

  @@map("table_payments")
}

// ============================================
// AÇÕES DE MESA (log)
// ============================================

model TableAction {
  id          String       @id @default(uuid())
  sessionId   String       @map("session_id")
  session     TableSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actionType  String       @map("action_type")
  performedBy String       @map("performed_by")
  description String
  metadata    String?
  performedAt DateTime     @default(now()) @map("performed_at")

  @@map("table_actions")
}

// ============================================
// VENDAS
// ============================================

model Sale {
  id            String    @id @default(uuid())
  saleNumber    String    @unique @map("sale_number")
  branchId      String    @map("branch_id")
  branch        Branch    @relation(fields: [branchId], references: [id])
  type          String    @default("counter")
  tableId       String?   @map("table_id")
  customerId    String?   @map("customer_id")
  customer      Customer? @relation(fields: [customerId], references: [id])
  cashierId     String    @map("cashier_id")
  status        String    @default("open")
  subtotal      Int       @default(0)
  taxTotal      Int       @default(0) @map("tax_total")
  discountTotal Int       @default(0) @map("discount_total")
  total         Int       @default(0)
  muntuSavings  Int       @default(0) @map("muntu_savings")
  notes         String?
  openedAt      DateTime  @default(now()) @map("opened_at")
  closedAt      DateTime? @map("closed_at")
  synced        Boolean   @default(false)
  syncPriority  Int       @default(0) @map("sync_priority")
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  items    SaleItem[]
  payments Payment[]
  debts    Debt[]
  stockMovements StockMovement[]

  @@map("sales")
}

// ============================================
// ITENS DE VENDA
// ============================================

model SaleItem {
  id             String   @id @default(uuid())
  saleId         String   @map("sale_id")
  sale           Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId      String   @map("product_id")
  product        Product  @relation(fields: [productId], references: [id])
  qtyUnits       Int      @map("qty_units")
  isMuntu        Boolean  @default(false) @map("is_muntu")
  unitPrice      Int      @map("unit_price")
  unitCost       Int      @map("unit_cost")
  subtotal       Int
  taxAmount      Int      @default(0) @map("tax_amount")
  discountAmount Int      @default(0) @map("discount_amount")
  total          Int
  muntuSavings   Int      @default(0) @map("muntu_savings")
  productionStatus String? @map("production_status")
  notes          String?
  synced         Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("sale_items")
}

// ============================================
// PAGAMENTOS
// ============================================

model Payment {
  id              String    @id @default(uuid())
  saleId          String?   @map("sale_id")
  sale            Sale?     @relation(fields: [saleId], references: [id])
  debtId          String?   @map("debt_id")
  method          String
  provider        String?
  amount          Int
  referenceNumber String?   @map("reference_number")
  transactionId   String?   @map("transaction_id")
  status          String    @default("completed")
  notes           String?
  processedAt     DateTime  @default(now()) @map("processed_at")
  synced          Boolean   @default(false)
  createdAt       DateTime  @default(now()) @map("created_at")

  tablePayments TablePayment[]
  debtPayments  DebtPayment[]

  @@map("payments")
}

// ============================================
// DÍVIDAS
// ============================================

model Debt {
  id             String    @id @default(uuid())
  debtNumber     String    @unique @map("debt_number")
  customerId     String    @map("customer_id")
  customer       Customer  @relation(fields: [customerId], references: [id])
  saleId         String?   @map("sale_id")
  sale           Sale?     @relation(fields: [saleId], references: [id])
  branchId       String    @map("branch_id")
  branch         Branch    @relation(fields: [branchId], references: [id])
  originalAmount Int       @map("original_amount")
  paidAmount     Int       @default(0) @map("paid_amount")
  balance        Int
  status         String    @default("open")
  dueDate        DateTime? @map("due_date")
  notes          String?
  createdBy      String?   @map("created_by")
  synced         Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  debtPayments DebtPayment[]

  @@map("debts")
}

// ============================================
// PAGAMENTOS DE DÍVIDA
// ============================================

model DebtPayment {
  id         String   @id @default(uuid())
  debtId     String   @map("debt_id")
  debt       Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)
  paymentId  String?  @map("payment_id")
  payment    Payment? @relation(fields: [paymentId], references: [id])
  amount     Int
  method     String
  reference  String?
  notes      String?
  receivedBy String?  @map("received_by")
  synced     Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("debt_payments")
}

// ============================================
// CAIXA
// ============================================

model CashBox {
  id              String    @id @default(uuid())
  boxNumber       String    @unique @map("box_number")
  branchId        String    @map("branch_id")
  branch          Branch    @relation(fields: [branchId], references: [id])
  openedBy        String    @map("opened_by")
  closedBy        String?   @map("closed_by")
  status          String    @default("open")
  openingCash     Int       @default(0) @map("opening_cash")
  totalSales      Int       @default(0) @map("total_sales")
  totalCash       Int       @default(0) @map("total_cash")
  totalCard       Int       @default(0) @map("total_card")
  totalMobileMoney Int      @default(0) @map("total_mobile_money")
  totalDebt       Int       @default(0) @map("total_debt")
  closingCash     Int       @default(0) @map("closing_cash")
  difference      Int       @default(0)
  notes           String?
  openedAt        DateTime  @default(now()) @map("opened_at")
  closedAt        DateTime? @map("closed_at")
  synced          Boolean   @default(false)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("cash_boxes")
}

// ============================================
// COMPRAS
// ============================================

model Purchase {
  id             String    @id @default(uuid())
  purchaseNumber String    @unique @map("purchase_number")
  branchId       String    @map("branch_id")
  branch         Branch    @relation(fields: [branchId], references: [id])
  supplierId     String?   @map("supplier_id")
  supplier       Supplier? @relation(fields: [supplierId], references: [id])
  status         String    @default("pending")
  subtotal       Int       @default(0)
  taxTotal       Int       @default(0) @map("tax_total")
  discountTotal  Int       @default(0) @map("discount_total")
  total          Int       @default(0)
  paymentMethod  String?   @map("payment_method")
  paymentStatus  String?   @map("payment_status")
  notes          String?
  receivedBy     String?   @map("received_by")
  receivedAt     DateTime? @map("received_at")
  synced         Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  items          PurchaseItem[]
  stockMovements StockMovement[]

  @@map("purchases")
}

// ============================================
// ITENS DE COMPRA
// ============================================

model PurchaseItem {
  id             String    @id @default(uuid())
  purchaseId     String    @map("purchase_id")
  purchase       Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  productId      String    @map("product_id")
  product        Product   @relation(fields: [productId], references: [id])
  qtyUnits       Int       @map("qty_units")
  unitCost       Int       @map("unit_cost")
  subtotal       Int
  taxAmount      Int       @default(0) @map("tax_amount")
  discountAmount Int       @default(0) @map("discount_amount")
  total          Int
  batchNumber    String?   @map("batch_number")
  expiryDate     DateTime? @map("expiry_date")
  synced         Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("purchase_items")
}

// ============================================
// INVENTÁRIO (tabela inventory)
// ============================================

model Inventory {
  id            String    @id @default(uuid())
  productId     String    @map("product_id")
  product       Product   @relation(fields: [productId], references: [id])
  branchId      String    @map("branch_id")
  branch        Branch    @relation(fields: [branchId], references: [id])
  quantityUnits Int       @default(0) @map("quantity_units")
  quantityBoxes Int       @default(0) @map("quantity_boxes")
  minStockUnits Int       @default(10) @map("min_stock_units")
  lastCountDate DateTime? @map("last_count_date")
  synced        Boolean   @default(false)
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([productId, branchId])
  @@map("inventory")
}

// ============================================
// ITENS DE INVENTÁRIO (tabela inventory_items)
// ============================================

model InventoryItem {
  id                String    @id @default(uuid())
  productId         String    @map("product_id")
  product           Product   @relation(fields: [productId], references: [id])
  branchId          String    @map("branch_id")
  qtyUnits          Int       @default(0) @map("qty_units")
  closedBoxes       Int       @default(0) @map("closed_boxes")
  openBoxUnits      Int       @default(0) @map("open_box_units")
  batchNumber       String?   @map("batch_number")
  expiryDate        DateTime? @map("expiry_date")
  location          String?
  consumptionAvg7d  Float     @default(0) @map("consumption_avg_7d")
  consumptionAvg15d Float     @default(0) @map("consumption_avg_15d")
  consumptionAvg30d Float     @default(0) @map("consumption_avg_30d")
  daysUntilStockout Int?      @map("days_until_stockout")
  suggestedReorder  Int?      @map("suggested_reorder")
  synced            Boolean   @default(false)
  lastSync          DateTime? @map("last_sync")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("inventory_items")
}

// ============================================
// MOVIMENTAÇÃO DE ESTOQUE
// ============================================

model StockMovement {
  id                     String    @id @default(uuid())
  productId              String    @map("product_id")
  product                Product   @relation(fields: [productId], references: [id])
  branchId               String    @map("branch_id")
  branch                 Branch    @relation(fields: [branchId], references: [id])
  movementType           String    @map("movement_type")
  quantity               Int
  quantityBefore         Int       @map("quantity_before")
  quantityAfter          Int       @map("quantity_after")
  closedBoxesBefore      Int       @default(0) @map("closed_boxes_before")
  closedBoxesAfter       Int       @default(0) @map("closed_boxes_after")
  openBoxBefore          Int       @default(0) @map("open_box_before")
  openBoxAfter           Int       @default(0) @map("open_box_after")
  boxOpenedAutomatically Boolean   @default(false) @map("box_opened_automatically")
  reason                 String
  responsible            String?
  terminal               String?
  saleId                 String?   @map("sale_id")
  sale                   Sale?     @relation(fields: [saleId], references: [id])
  purchaseId             String?   @map("purchase_id")
  purchase               Purchase? @relation(fields: [purchaseId], references: [id])
  notes                  String?
  synced                 Boolean   @default(false)
  createdAt              DateTime  @default(now()) @map("created_at")

  @@map("stock_movements")
}

// ============================================
// FILA DE SINCRONIZAÇÃO
// ============================================

model SyncQueue {
  id          String    @id @default(uuid())
  operation   String
  entity      String
  entityId    String    @map("entity_id")
  data        String
  priority    Int       @default(0)
  status      String    @default("pending")
  retryCount  Int       @default(0) @map("retry_count")
  lastError   String?   @map("last_error")
  createdAt   DateTime  @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")

  @@map("sync_queue")
}

// ============================================
// CONFIGURAÇÕES
// ============================================

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
