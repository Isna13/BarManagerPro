// Schema Prisma para BarManager Pro
// Baseado 100% na estrutura do SQLite do Electron Desktop
// Gerado em: 30/11/2025

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// FILIAIS
// ============================================

model Branch {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  address   String?
  phone     String?
  isMain    Boolean  @default(false) @map("is_main")
  isActive  Boolean  @default(true) @map("is_active")
  synced    Boolean  @default(false)
  lastSync  DateTime? @map("last_sync")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  users          User[]
  sales          Sale[]
  cashBoxes      CashBox[]
  debts          Debt[]
  purchases      Purchase[]
  tables         Table[]
  tableSessions  TableSession[]
  inventory      Inventory[]
  inventoryItems InventoryItem[]
  stockMovements StockMovement[]
  auditLogs      AuditLog[]
  notifications  Notification[]
  campaigns      Campaign[]
  feedbacks      Feedback[]
  customers      Customer[]
  suppliers      Supplier[]
  products       Product[]
  transfersFrom  InventoryTransfer[] @relation("TransfersFrom")
  transfersTo    InventoryTransfer[] @relation("TransfersTo")

  @@map("branches")
}

// ============================================
// USUÁRIOS
// ============================================

model User {
  id           String    @id @default(uuid())
  username     String?   @unique
  email        String    @unique
  fullName     String    @map("full_name")
  password     String    // Para autenticação do backend
  passwordHash String?   @map("password_hash") // Hash do Electron
  role         String    @default("cashier")
  roleName     String?   @map("role_name") // Compatibilidade
  branchId     String?   @map("branch_id")
  branch       Branch?   @relation(fields: [branchId], references: [id])
  phone        String?
  language     String?   @default("pt")
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  synced       Boolean   @default(false)
  lastSync     DateTime? @map("last_sync")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  debts             Debt[]
  sessions          Session[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  cashBoxesOpened   CashBox[]  @relation("CashBoxOpenedBy")
  cashBoxesClosed   CashBox[]  @relation("CashBoxClosedBy")
  purchasesCreated  Purchase[] @relation("PurchaseCreatedBy")
  sales             Sale[]

  @@map("users")
}

// ============================================
// CATEGORIAS
// ============================================

model Category {
  id          String     @id @default(uuid())
  name        String
  nameKriol   String?    @map("name_kriol")
  nameFr      String?    @map("name_fr")
  description String?
  parentId    String?    @map("parent_id")
  parent      Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children    Category[] @relation("SubCategories")
  sortOrder   Int        @default(0) @map("sort_order")
  isActive    Boolean    @default(true) @map("is_active")
  synced      Boolean    @default(false)
  lastSync    DateTime?  @map("last_sync")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  products Product[]

  @@map("categories")
}

// ============================================
// FORNECEDORES
// ============================================

model Supplier {
  id            String    @id @default(uuid())
  code          String    @unique
  name          String
  branchId      String?   @map("branch_id")
  branch        Branch?   @relation(fields: [branchId], references: [id])
  contactPerson String?   @map("contact_person")
  phone         String?
  email         String?
  address       String?
  taxId         String?   @map("tax_id")
  paymentTerms  String?   @map("payment_terms")
  notes         String?
  isActive      Boolean   @default(true) @map("is_active")
  synced        Boolean   @default(false)
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  products  Product[]
  purchases Purchase[]

  @@map("suppliers")
}

// ============================================
// PRODUTOS
// ============================================

model Product {
  id               String    @id @default(uuid())
  sku              String    @unique
  barcode          String?   @unique
  name             String
  description      String?
  nameKriol        String?   @map("name_kriol")
  nameFr           String?   @map("name_fr")
  categoryId       String?   @map("category_id")
  category         Category? @relation(fields: [categoryId], references: [id])
  branchId         String?   @map("branch_id")
  branch           Branch?   @relation(fields: [branchId], references: [id])
  supplierId       String?   @map("supplier_id")
  supplier         Supplier? @relation(fields: [supplierId], references: [id])
  priceUnit        Int       @map("price_unit")
  priceBox         Int?      @map("price_box")
  costUnit         Int       @map("cost_unit")
  costBox          Int?      @map("cost_box")
  unitsPerBox      Int       @default(1) @map("units_per_box")
  boxEnabled       Boolean   @default(false) @map("box_enabled")
  trackInventory   Boolean   @default(true) @map("track_inventory")
  lowStockAlert    Int       @default(10) @map("low_stock_alert")
  isMuntuEligible  Boolean   @default(false) @map("is_muntu_eligible")
  muntuQuantity    Int?      @map("muntu_quantity")
  muntuPrice       Int?      @map("muntu_price")
  maxDiscountMuntu Float?    @map("max_discount_muntu")
  minMarginPercent Float     @default(0) @map("min_margin_percent")
  taxRate          Float     @default(0) @map("tax_rate")
  isActive         Boolean   @default(true) @map("is_active")
  doseEnabled      Boolean   @default(false) @map("dose_enabled")
  dosesPerBottle   Int?      @map("doses_per_bottle")
  synced           Boolean   @default(false)
  lastSync         DateTime? @map("last_sync")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  saleItems      SaleItem[]
  purchaseItems  PurchaseItem[]
  inventory      Inventory[]
  inventoryItems InventoryItem[]
  stockMovements StockMovement[]
  tableOrders    TableOrder[]
  priceHistory   ProductPriceHistory[]

  @@map("products")
}

// ============================================
// CLIENTES
// ============================================

model Customer {
  id            String    @id @default(uuid())
  code          String    @unique
  fullName      String    @map("full_name")
  phone         String?
  email         String?
  address       String?
  branchId      String?   @map("branch_id")
  branch        Branch?   @relation(fields: [branchId], references: [id])
  creditLimit   Int       @default(0) @map("credit_limit")
  currentDebt   Int       @default(0) @map("current_debt")
  isBlocked     Boolean   @default(false) @map("is_blocked")
  loyaltyPoints Int       @default(0) @map("loyalty_points")
  totalSpent    Int       @default(0) @map("total_spent")
  notes         String?
  isActive      Boolean   @default(true) @map("is_active")
  synced        Boolean   @default(false)
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  sales               Sale[]
  debts               Debt[]
  tableCustomers      TableCustomer[]
  feedbacks           Feedback[]
  loyaltyTransactions LoyaltyTransaction[]

  @@map("customers")
}

// ============================================
// MESAS
// ============================================

model Table {
  id        String   @id @default(uuid())
  branchId  String   @map("branch_id")
  branch    Branch   @relation(fields: [branchId], references: [id])
  number    String
  seats     Int      @default(4)
  area      String?
  qrCode    String?  @map("qr_code")
  isActive  Boolean  @default(true) @map("is_active")
  synced    Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sessions TableSession[]
  sales    Sale[]

  @@unique([branchId, number])
  @@map("tables")
}

// ============================================
// SESSÕES DE MESA
// ============================================

model TableSession {
  id            String    @id @default(uuid())
  tableId       String    @map("table_id")
  table         Table     @relation(fields: [tableId], references: [id])
  branchId      String    @map("branch_id")
  branch        Branch    @relation(fields: [branchId], references: [id])
  sessionNumber String    @map("session_number")
  status        String    @default("open")
  openedBy      String    @map("opened_by")
  closedBy      String?   @map("closed_by")
  openedAt      DateTime  @default(now()) @map("opened_at")
  closedAt      DateTime? @map("closed_at")
  totalAmount   Int       @default(0) @map("total_amount")
  paidAmount    Int       @default(0) @map("paid_amount")
  notes         String?
  synced        Boolean   @default(false)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  customers TableCustomer[]
  orders    TableOrder[]
  payments  TablePayment[]
  actions   TableAction[]

  @@map("table_sessions")
}

// ============================================
// CLIENTES DE MESA (conta individual)
// ============================================

model TableCustomer {
  id            String        @id @default(uuid())
  sessionId     String        @map("session_id")
  session       TableSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  customerName  String        @map("customer_name")
  customerId    String?       @map("customer_id")
  customer      Customer?     @relation(fields: [customerId], references: [id])
  orderSequence Int           @default(1) @map("order_sequence")
  subtotal      Int           @default(0)
  discount      Int           @default(0)
  total         Int           @default(0)
  paidAmount    Int           @default(0) @map("paid_amount")
  paymentStatus String        @default("pending") @map("payment_status")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  orders   TableOrder[]
  payments TablePayment[]

  @@map("table_customers")
}

// ============================================
// PEDIDOS DE MESA
// ============================================

model TableOrder {
  id              String         @id @default(uuid())
  sessionId       String         @map("session_id")
  session         TableSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tableCustomerId String         @map("table_customer_id")
  tableCustomer   TableCustomer  @relation(fields: [tableCustomerId], references: [id], onDelete: Cascade)
  productId       String         @map("product_id")
  product         Product        @relation(fields: [productId], references: [id])
  qtyUnits        Int            @map("qty_units")
  isMuntu         Boolean        @default(false) @map("is_muntu")
  unitPrice       Int            @map("unit_price")
  unitCost        Int            @map("unit_cost")
  subtotal        Int
  discount        Int            @default(0)
  total           Int
  status          String         @default("pending")
  notes           String?
  orderedBy       String         @map("ordered_by")
  orderedAt       DateTime       @default(now()) @map("ordered_at")
  cancelledAt     DateTime?      @map("cancelled_at")
  cancelledBy     String?        @map("cancelled_by")
  synced          Boolean        @default(false)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("table_orders")
}

// ============================================
// PAGAMENTOS DE MESA
// ============================================

model TablePayment {
  id              String         @id @default(uuid())
  sessionId       String         @map("session_id")
  session         TableSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tableCustomerId String?        @map("table_customer_id")
  tableCustomer   TableCustomer? @relation(fields: [tableCustomerId], references: [id])
  paymentId       String?        @map("payment_id")
  payment         Payment?       @relation(fields: [paymentId], references: [id])
  method          String
  amount          Int
  referenceNumber String?        @map("reference_number")
  status          String         @default("completed")
  processedBy     String         @map("processed_by")
  processedAt     DateTime?      @map("processed_at")
  notes           String?
  synced          Boolean        @default(false)
  createdAt       DateTime       @default(now()) @map("created_at")

  @@map("table_payments")
}

// ============================================
// AÇÕES DE MESA (log)
// ============================================

model TableAction {
  id          String       @id @default(uuid())
  sessionId   String       @map("session_id")
  session     TableSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actionType  String       @map("action_type")
  performedBy String       @map("performed_by")
  description String
  metadata    String?
  performedAt DateTime     @default(now()) @map("performed_at")

  @@map("table_actions")
}

// ============================================
// VENDAS
// ============================================

model Sale {
  id            String    @id @default(uuid())
  saleNumber    String    @unique @map("sale_number")
  branchId      String    @map("branch_id")
  branch        Branch    @relation(fields: [branchId], references: [id])
  type          String    @default("counter")
  tableId       String?   @map("table_id")
  table         Table?    @relation(fields: [tableId], references: [id])
  customerId    String?   @map("customer_id")
  customer      Customer? @relation(fields: [customerId], references: [id])
  customerName  String?   @map("customer_name") // Nome do cliente para vendas sem cadastro
  cashierId     String    @map("cashier_id")
  cashier       User?     @relation(fields: [cashierId], references: [id])
  status         String    @default("open")
  paymentMethod  String?   @map("payment_method")
  subtotal       Int       @default(0)
  taxTotal       Int       @default(0) @map("tax_total")
  discountTotal  Int       @default(0) @map("discount_total")
  total          Int       @default(0)
  muntuSavings   Int       @default(0) @map("muntu_savings")
  notes          String?
  openedAt      DateTime  @default(now()) @map("opened_at")
  closedAt      DateTime? @map("closed_at")
  synced        Boolean   @default(false)
  syncPriority  Int       @default(0) @map("sync_priority")
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  items          SaleItem[]
  payments       Payment[]
  debts          Debt[]
  stockMovements StockMovement[]
  feedbacks      Feedback[]

  @@map("sales")
}

// ============================================
// ITENS DE VENDA
// ============================================

model SaleItem {
  id             String   @id @default(uuid())
  saleId         String   @map("sale_id")
  sale           Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId      String   @map("product_id")
  product        Product  @relation(fields: [productId], references: [id])
  qtyUnits       Int      @map("qty_units")
  isMuntu        Boolean  @default(false) @map("is_muntu")
  unitPrice      Int      @map("unit_price")
  unitCost       Int      @map("unit_cost")
  subtotal       Int
  tax            Float    @default(0)
  taxAmount      Int      @default(0) @map("tax_amount")
  discountAmount Int      @default(0) @map("discount_amount")
  total          Int
  muntuSavings   Int      @default(0) @map("muntu_savings")
  productionStatus String? @map("production_status")
  notes          String?
  synced         Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("sale_items")
}

// ============================================
// PAGAMENTOS
// ============================================

model Payment {
  id              String    @id @default(uuid())
  saleId          String?   @map("sale_id")
  sale            Sale?     @relation(fields: [saleId], references: [id])
  debtId          String?   @map("debt_id")
  debt            Debt?     @relation(fields: [debtId], references: [id])
  method          String
  provider        String?
  amount          Int
  referenceNumber String?   @map("reference_number")
  transactionId   String?   @map("transaction_id")
  status          String    @default("completed")
  notes           String?
  processedAt     DateTime  @default(now()) @map("processed_at")
  synced          Boolean   @default(false)
  createdAt       DateTime  @default(now()) @map("created_at")

  tablePayments TablePayment[]
  debtPayments  DebtPayment[]

  @@map("payments")
}

// ============================================
// DÍVIDAS
// ============================================

model Debt {
  id             String    @id @default(uuid())
  debtNumber     String    @unique @map("debt_number")
  customerId     String    @map("customer_id")
  customer       Customer  @relation(fields: [customerId], references: [id])
  saleId         String?   @map("sale_id")
  sale           Sale?     @relation(fields: [saleId], references: [id])
  branchId       String?   @map("branch_id")
  branch         Branch?   @relation(fields: [branchId], references: [id])
  amount         Int       @default(0)               // Para compatibilidade backend
  paid           Int       @default(0)               // Para compatibilidade backend
  originalAmount Int       @map("original_amount")
  paidAmount     Int       @default(0) @map("paid_amount")
  balance        Int
  status         String    @default("open")
  dueDate        DateTime? @map("due_date")
  notes          String?
  createdBy      String?   @map("created_by")
  createdByUser  User?     @relation(fields: [createdBy], references: [id])
  synced         Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  debtPayments DebtPayment[]
  payments     Payment[]

  @@map("debts")
}

// ============================================
// PAGAMENTOS DE DÍVIDA
// ============================================

model DebtPayment {
  id         String   @id @default(uuid())
  debtId     String   @map("debt_id")
  debt       Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)
  paymentId  String?  @map("payment_id")
  payment    Payment? @relation(fields: [paymentId], references: [id])
  amount     Int
  method     String
  reference  String?
  notes      String?
  receivedBy String?  @map("received_by")
  synced     Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("debt_payments")
}

// ============================================
// CAIXA
// ============================================

model CashBox {
  id              String    @id @default(uuid())
  boxNumber       String    @unique @map("box_number")
  branchId        String    @map("branch_id")
  branch          Branch    @relation(fields: [branchId], references: [id])
  openedBy        String    @map("opened_by")
  openedByUser    User      @relation("CashBoxOpenedBy", fields: [openedBy], references: [id])
  closedBy        String?   @map("closed_by")
  closedByUser    User?     @relation("CashBoxClosedBy", fields: [closedBy], references: [id])
  status          String    @default("open")
  openingCash     Int       @default(0) @map("opening_cash")
  totalSales      Int       @default(0) @map("total_sales")
  totalCash       Int       @default(0) @map("total_cash")
  totalCard       Int       @default(0) @map("total_card")
  totalMobileMoney Int      @default(0) @map("total_mobile_money")
  totalDebt       Int       @default(0) @map("total_debt")
  closingCash     Int       @default(0) @map("closing_cash")
  difference      Int       @default(0)
  notes           String?
  openedAt        DateTime  @default(now()) @map("opened_at")
  closedAt        DateTime? @map("closed_at")
  synced          Boolean   @default(false)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("cash_boxes")
}

// ============================================
// COMPRAS
// ============================================

model Purchase {
  id             String    @id @default(uuid())
  purchaseNumber String    @unique @map("purchase_number")
  branchId       String    @map("branch_id")
  branch         Branch    @relation(fields: [branchId], references: [id])
  supplierId     String?   @map("supplier_id")
  supplier       Supplier? @relation(fields: [supplierId], references: [id])
  createdBy      String?   @map("created_by")
  createdByUser  User?     @relation("PurchaseCreatedBy", fields: [createdBy], references: [id])
  status         String    @default("pending")
  subtotal       Int       @default(0)
  taxTotal       Int       @default(0) @map("tax_total")
  discountTotal  Int       @default(0) @map("discount_total")
  total          Int       @default(0)
  totalCost      Int       @default(0) @map("total_cost")
  completedAt    DateTime? @map("completed_at")
  paymentMethod  String?   @map("payment_method")
  paymentStatus  String?   @map("payment_status")
  notes          String?
  receivedBy     String?   @map("received_by")
  receivedAt     DateTime? @map("received_at")
  synced         Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  items          PurchaseItem[]
  stockMovements StockMovement[]

  @@map("purchases")
}

// ============================================
// ITENS DE COMPRA
// ============================================

model PurchaseItem {
  id             String    @id @default(uuid())
  purchaseId     String    @map("purchase_id")
  purchase       Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  productId      String    @map("product_id")
  product        Product   @relation(fields: [productId], references: [id])
  qtyUnits       Int       @map("qty_units")
  qtyBoxes       Int       @default(0) @map("qty_boxes")
  unitCost       Int       @map("unit_cost")
  subtotal       Int
  taxAmount      Int       @default(0) @map("tax_amount")
  discountAmount Int       @default(0) @map("discount_amount")
  total          Int
  batchNumber    String?   @map("batch_number")
  expiryDate     DateTime? @map("expiry_date")
  synced         Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("purchase_items")
}

// ============================================
// INVENTÁRIO (tabela inventory)
// ============================================

model Inventory {
  id            String    @id @default(uuid())
  productId     String    @map("product_id")
  product       Product   @relation(fields: [productId], references: [id])
  branchId      String    @map("branch_id")
  branch        Branch    @relation(fields: [branchId], references: [id])
  quantityUnits Int       @default(0) @map("quantity_units")
  quantityBoxes Int       @default(0) @map("quantity_boxes")
  minStockUnits Int       @default(10) @map("min_stock_units")
  lastCountDate DateTime? @map("last_count_date")
  synced        Boolean   @default(false)
  lastSync      DateTime? @map("last_sync")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@unique([productId, branchId])
  @@map("inventory")
}

// ============================================
// ITENS DE INVENTÁRIO (tabela inventory_items)
// ============================================

model InventoryItem {
  id                String    @id @default(uuid())
  productId         String    @map("product_id")
  product           Product   @relation(fields: [productId], references: [id])
  branchId          String    @map("branch_id")
  branch            Branch    @relation(fields: [branchId], references: [id])
  qtyUnits          Int       @default(0) @map("qty_units")
  qtyBoxes          Int       @default(0) @map("qty_boxes")
  closedBoxes       Int       @default(0) @map("closed_boxes")
  openBoxUnits      Int       @default(0) @map("open_box_units")
  minStock          Int       @default(10) @map("min_stock")
  batchNumber       String?   @map("batch_number")
  expiryDate        DateTime? @map("expiry_date")
  location          String?
  consumptionAvg7d  Float     @default(0) @map("consumption_avg_7d")
  consumptionAvg15d Float     @default(0) @map("consumption_avg_15d")
  consumptionAvg30d Float     @default(0) @map("consumption_avg_30d")
  daysUntilStockout Int?      @map("days_until_stockout")
  suggestedReorder  Int?      @map("suggested_reorder")
  synced            Boolean   @default(false)
  lastSync          DateTime? @map("last_sync")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  movements InventoryMovement[]

  @@map("inventory_items")
}

// ============================================
// MOVIMENTAÇÃO DE ESTOQUE
// ============================================

model StockMovement {
  id                     String    @id @default(uuid())
  productId              String    @map("product_id")
  product                Product   @relation(fields: [productId], references: [id])
  branchId               String    @map("branch_id")
  branch                 Branch    @relation(fields: [branchId], references: [id])
  movementType           String    @map("movement_type")
  quantity               Int
  quantityBefore         Int       @map("quantity_before")
  quantityAfter          Int       @map("quantity_after")
  closedBoxesBefore      Int       @default(0) @map("closed_boxes_before")
  closedBoxesAfter       Int       @default(0) @map("closed_boxes_after")
  openBoxBefore          Int       @default(0) @map("open_box_before")
  openBoxAfter           Int       @default(0) @map("open_box_after")
  boxOpenedAutomatically Boolean   @default(false) @map("box_opened_automatically")
  reason                 String
  responsible            String?
  terminal               String?
  saleId                 String?   @map("sale_id")
  sale                   Sale?     @relation(fields: [saleId], references: [id])
  purchaseId             String?   @map("purchase_id")
  purchase               Purchase? @relation(fields: [purchaseId], references: [id])
  notes                  String?
  synced                 Boolean   @default(false)
  createdAt              DateTime  @default(now()) @map("created_at")

  @@map("stock_movements")
}

// ============================================
// FILA DE SINCRONIZAÇÃO
// ============================================

model SyncQueue {
  id          String    @id @default(uuid())
  operation   String
  entity      String
  entityId    String    @map("entity_id")
  data        String
  branchId    String?   @map("branch_id")
  deviceId    String?   @map("device_id")
  priority    Int       @default(0)
  status      String    @default("pending")
  retryCount  Int       @default(0) @map("retry_count")
  lastError   String?   @map("last_error")
  createdAt   DateTime  @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")

  @@map("sync_queue")
}

// ============================================
// CONFIGURAÇÕES
// ============================================

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ============================================
// TABELAS ADICIONAIS PARA COMPATIBILIDADE COM BACKEND
// (Não usadas pelo Electron desktop ainda)
// ============================================

model Session {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  token      String   @unique
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("sessions")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  user       User?    @relation(fields: [userId], references: [id])
  branchId   String?  @map("branch_id")
  branch     Branch?  @relation(fields: [branchId], references: [id])
  action     String
  entity     String
  resource   String?
  resourceId String?  @map("resource_id")
  details    String?
  entityId   String?  @map("entity_id")
  oldData    String?  @map("old_data")
  newData    String?  @map("new_data")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

model Notification {
  id        String    @id @default(uuid())
  userId    String?   @map("user_id")
  user      User?     @relation(fields: [userId], references: [id])
  branchId  String?   @map("branch_id")
  branch    Branch?   @relation(fields: [branchId], references: [id])
  type      String
  title     String
  message   String
  data      String?
  metadata  String?
  priority  String?   @default("normal")
  read      Boolean   @default(false)
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("notifications")
}

model Campaign {
  id              String    @id @default(uuid())
  name            String
  description     String?
  type            String
  status          String    @default("draft")
  branchId        String?   @map("branch_id")
  branch          Branch?   @relation(fields: [branchId], references: [id])
  discountPercent Float?    @map("discount_percent")
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  rules           String?
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("campaigns")
}

model Feedback {
  id         String    @id @default(uuid())
  customerId String?   @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])
  saleId     String?   @map("sale_id")
  sale       Sale?     @relation(fields: [saleId], references: [id])
  branchId   String?   @map("branch_id")
  branch     Branch?   @relation(fields: [branchId], references: [id])
  rating     Int
  comment    String?
  category   String?
  createdAt  DateTime  @default(now()) @map("created_at")

  @@map("feedbacks")
}

model LoyaltyTransaction {
  id          String    @id @default(uuid())
  customerId  String    @map("customer_id")
  customer    Customer  @relation(fields: [customerId], references: [id])
  type        String
  points      Int
  description String?
  notes       String?
  referenceId String?   @map("reference_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("loyalty_transactions")
}

model LoyaltyReward {
  id             String   @id @default(uuid())
  name           String
  description    String?
  branchId       String?  @map("branch_id")
  pointsCost     Int      @map("points_cost")
  pointsRequired Int      @default(0) @map("points_required")
  rewardType     String   @default("discount") @map("reward_type")
  rewardValue    String?  @map("reward_value")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("loyalty_rewards")
}

model InventoryMovement {
  id              String        @id @default(uuid())
  inventoryItemId String        @map("inventory_item_id")
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  type            String
  qtyUnits        Int           @map("qty_units")
  reason          String?
  notes           String?
  referenceType   String?       @map("reference_type")
  referenceId     String?       @map("reference_id")
  performedBy     String?       @map("performed_by")
  createdAt       DateTime      @default(now()) @map("created_at")

  @@map("inventory_movements")
}

model ProductPriceHistory {
  id            String    @id @default(uuid())
  productId     String    @map("product_id")
  product       Product   @relation(fields: [productId], references: [id])
  priceUnit     Int       @map("price_unit")
  priceBox      Int?      @map("price_box")
  costUnit      Int       @map("cost_unit")
  costBox       Int?      @map("cost_box")
  reason        String?
  changedBy     String?   @map("changed_by")
  effectiveFrom DateTime  @default(now()) @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@map("product_price_history")
}

model SyncConflict {
  id         String    @id @default(uuid())
  deviceId   String    @map("device_id")
  branchId   String?   @map("branch_id")
  entity     String
  entityId   String    @map("entity_id")
  localData  String    @map("local_data")
  remoteData String    @map("remote_data")
  resolution String?
  resolved   Boolean   @default(false)
  resolvedBy String?   @map("resolved_by")
  resolvedAt DateTime? @map("resolved_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@map("sync_conflicts")
}

// ============================================
// TRANSFERÊNCIA DE INVENTÁRIO (Backend only)
// ============================================

model InventoryTransfer {
  id           String   @id @default(uuid())
  fromBranchId String   @map("from_branch_id")
  fromBranch   Branch   @relation("TransfersFrom", fields: [fromBranchId], references: [id])
  toBranchId   String   @map("to_branch_id")
  toBranch     Branch   @relation("TransfersTo", fields: [toBranchId], references: [id])
  items        Json     @default("[]")
  requestedBy  String   @map("requested_by")
  approvedBy   String?  @map("approved_by")
  status       String   @default("pending")
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("inventory_transfers")
}

